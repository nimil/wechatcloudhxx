# 图片检测功能使用说明

## 功能概述

本功能实现了微信小程序图片内容安全检测，确保只有合规的图片内容才能被展示。

## 主要特性

- ✅ 自动检测用户发布帖子时的图片内容
- ✅ 异步处理，不阻塞用户操作
- ✅ 状态管理：待检测 → 检测中 → 检测通过/失败
- ✅ 只展示图片检测通过的帖子
- ✅ 完整的回调处理机制

## 状态说明

### 帖子状态
- `0` - 待检测（刚创建的帖子）
- `1` - 检测中（图片正在被检测）
- `2` - 检测通过（所有图片检测通过，可以展示）
- `3` - 检测失败（有图片检测失败，不展示）

### 图片状态
- `0` - 待检测
- `1` - 检测中
- `2` - 检测通过
- `3` - 检测失败

## 使用流程

### 1. 发布帖子
用户发布包含图片的帖子时，系统会：
1. 创建帖子记录
2. 提交图片检测请求到微信服务器
3. 记录检测信息到数据库
4. 设置帖子状态为"检测中"

### 2. 图片检测
微信服务器异步检测图片内容，完成后通过回调接口返回结果。

### 3. 状态更新
系统接收回调后：
1. 更新图片检测状态
2. 检查所有图片是否检测完成
3. 更新帖子状态

### 4. 帖子展示
只有图片检测通过的帖子才会在列表中显示。

## 配置要求

### 1. 数据库迁移
执行 `sql/image_check_migration.sql` 中的SQL语句：
```sql
-- 添加图片检测状态字段
ALTER TABLE posts ADD COLUMN image_check_status INT DEFAULT 0;

-- 创建图片检测记录表
CREATE TABLE image_checks (...);
```

### 2. 微信回调配置
在微信小程序后台配置回调URL：
- 回调地址：`https://your-domain.com/api/wechat/callback`
- 事件类型：`wxa_media_check`

## API接口

### 微信回调接口
- **地址**：`POST /api/wechat/callback`
- **功能**：接收微信异步推送的图片检测结果

## 注意事项

1. **图片格式**：支持 jpg, jpeg, png, bmp, gif
2. **图片大小**：建议不超过10MB
3. **图片URL**：必须是可访问的公开链接
4. **用户活跃度**：openid对应的用户需要在近两小时内访问过小程序
5. **异步处理**：检测结果是异步返回的，需要等待回调

## 故障排查

### 常见问题
1. **图片检测失败**：检查图片URL是否可访问，格式是否支持
2. **回调未收到**：检查回调URL配置是否正确
3. **帖子不显示**：检查图片检测状态是否为"检测通过"

### 日志查看
系统会记录详细的检测日志，包括：
- 图片检测请求提交
- 微信回调接收
- 检测状态更新
- 帖子状态变更

## 相关文件

- `service/wechat_callback.go` - 微信回调处理
- `db/model/image_check.go` - 图片检测模型
- `db/dao/image_check_dao.go` - 图片检测数据访问
- `service/post_service.go` - 帖子服务（已集成图片检测）
- `sql/image_check_migration.sql` - 数据库迁移脚本
